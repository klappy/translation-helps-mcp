echo "🔍 Running pre-commit checks..."

# Run lint-staged for basic linting and formatting
npx lint-staged

# Removed brittle terminology checks that caused false positives

# Check for missing UW resource types in new API handlers
if git diff --cached --name-only --diff-filter=A | grep -q "src/functions/handlers/.*\.ts$"; then
  echo "📋 New API handler detected. Ensure it uses proper UW terminology:"
  echo "   - Use ResourceType enum from terminology constants"
  echo "   - Include UW-specific descriptions"
  echo "   - Reference UW_TRANSLATION_RESOURCES_GUIDE.md for specifications"
  echo ""
fi

echo "✅ Pre-commit checks passed!"

# Sync version files before commit
echo "🔄 Syncing version files..."
npm run sync-version >/dev/null 2>&1 || true

# ALWAYS run prettier on everything to avoid formatting surprises later
# This prevents the "dirty files after push" problem
echo "🧹 Running prettier on entire repository..."
npm run format >/dev/null 2>&1 || true

# Check if prettier made any changes
if ! git diff --quiet; then
  echo "🔧 Prettier made formatting changes. Adding them to commit..."
  git add -A
fi

# Add version files if they changed
if git diff --quiet src/version.ts ui/src/lib/version.ts ui/src/routes/api/health/+server.ts 2>/dev/null; then
  echo "📌 Version files unchanged"
else
  echo "📌 Adding updated version files..."
  git add src/version.ts ui/src/lib/version.ts ui/src/routes/api/health/+server.ts 2>/dev/null || true
fi
